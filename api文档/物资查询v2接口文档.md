# 物资查询v2接口文档

## 接口概述

本接口提供基于v1.3.3新状态定义逻辑的物资查询功能，支持分页、筛选、搜索等功能。

## 接口信息

- **接口名称**: 复杂查询乙供物资解析结果v2
- **接口路径**: `POST /materials/partyb/queryV2`
- **版本**: v1.3.3
- **方法**: POST

## 请求参数

### 请求体格式

```json
{
    "taskId": "task123",
    "page": 0,
    "size": 10,
    "keyword": "钢筋",
    "confirmResult": 1,
    "matchedType": 1,
    "materialMatchingStatus": 1
}
```

### 请求参数说明

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|-------|------|------|--------|------|
| taskId | String | 是 | - | 任务ID |
| page | Integer | 否 | 0 | 页码，从0开始 |
| size | Integer | 否 | 10 | 每页大小 |
| keyword | String | 否 | - | 搜索关键词，支持物资名称、规格型号、单位模糊搜索 |
| confirmResult | Integer | 否 | - | 确认结果筛选：0-未确认，1-已确认 |
| matchedType | Integer | 否 | - | 匹配类型筛选：0-无匹配，1-精确匹配，2-相似匹配，3-历史匹配，4-人工匹配 |
| materialMatchingStatus | Integer | 否 | - | 物资匹配状态筛选：1-精确匹配，2-信息待确认，3-物资信息待处理 |

### 请求示例

```http
POST /materials/partyb/queryV2
Content-Type: application/json

{
    "taskId": "task123",
    "page": 0,
    "size": 20,
    "keyword": "钢筋",
    "materialMatchingStatus": 1
}
```

## 响应数据

### 响应格式

```json
{
    "content": [
        {
            "id": 1,
            "taskId": "task123",
            "materialName": "螺纹钢筋",
            "specificationModel": "HRB400 Φ12",
            "unit": "kg",
            "quantity": 1000.0,
            "originalPrice": 4500.0,
            "taxPrice": 4500.0,
            "taxExcludedPrice": 3982.3,
            "priceType": 1,
            "taxRate": 0.13,
            "comparisonResult": 1,
            "confirmResult": 1,
            "confirmType": 1,
            "confirmBaseDataId": 123,
            "confirmPriceId": 456,
            "confirmPrice": 4200.0,
            "matchedResultCount": 3
        }
    ],
    "totalElements": 100,
    "totalPages": 5,
    "number": 0,
    "size": 20,
    "first": true,
    "last": false,
    "statistics": {
        "totalMaterials": 100,
        "exactMatchCount": 60,
        "infoPendingConfirmationCount": 25,
        "materialInfoPendingCount": 15
    }
}
```

### 响应字段说明

#### 分页信息

| 字段名 | 类型 | 说明 |
|-------|------|------|
| content | Array | 查询结果列表 |
| totalElements | Long | 总记录数 |
| totalPages | Integer | 总页数 |
| number | Integer | 当前页码 |
| size | Integer | 每页大小 |
| first | Boolean | 是否为第一页 |
| last | Boolean | 是否为最后一页 |
| statistics | Object | 统计信息 |

#### 物资信息字段

| 字段名 | 类型 | 说明 |
|-------|------|------|
| id | Long | 记录ID |
| taskId | String | 任务ID |
| materialName | String | 物资名称 |
| specificationModel | String | 规格型号 |
| unit | String | 单位 |
| quantity | BigDecimal | 数量 |
| originalPrice | BigDecimal | 从Excel文件中读取的原始价格 |
| taxPrice | BigDecimal | 含税价格 |
| taxExcludedPrice | BigDecimal | 不含税价格 |
| priceType | Integer | 价格类型标识（1=含税价，0=不含税价） |
| taxRate | BigDecimal | 税率 |
| comparisonResult | Integer | 匹配类型：0-无匹配，1-精确匹配，2-相似匹配，3-历史匹配，4-人工匹配 |
| confirmResult | Integer | 确认结果：0-未确认，1-已确认 |
| confirmType | Integer | 确认类型 |
| confirmBaseDataId | Long | 确认的基础数据ID |
| confirmPriceId | Long | 确认的价格数据ID |
| confirmPrice | BigDecimal | 确认价格 |
| matchedResultCount | Integer | 匹配结果数量 |

#### 统计信息字段

| 字段名 | 类型 | 说明 |
|-------|------|------|
| totalMaterials | BigInteger | 总物资数量 |
| exactMatchCount | BigInteger | 精确匹配数量 |
| infoPendingConfirmationCount | BigInteger | 信息待确认数量 |
| materialInfoPendingCount | BigInteger | 物资信息待处理数量 |

## 筛选逻辑说明

### materialMatchingStatus筛选逻辑

#### 1. 精确匹配 (materialMatchingStatus = 1)
- 条件: 物资已确认或匹配成功，且价格匹配状态为1
- SQL条件:
```sql
((t.confirmResult = 1 OR t.comparisonResult IN (1, 3)) AND
 EXISTS (SELECT 1 FROM MaterialMatchedResultDO mr WHERE mr.yMateraukTaskDataId = t.id AND mr.priceMatchedStatus = 1))
```

#### 2. 信息待确认 (materialMatchingStatus = 2)
- 条件: 物资已确认或匹配成功，但价格匹配状态不为1
- SQL条件:
```sql
((t.confirmResult = 1 OR t.comparisonResult IN (1, 3)) AND
 NOT EXISTS (SELECT 1 FROM MaterialMatchedResultDO mr WHERE mr.yMateraukTaskDataId = t.id AND mr.priceMatchedStatus = 1))
```

#### 3. 物资信息待处理 (materialMatchingStatus = 3)
- 条件: 物资未确认且不是历史/精确匹配
- SQL条件:
```sql
(t.confirmResult = 0 AND
 (t.comparisonResult NOT IN (1, 3) OR t.comparisonResult IS NULL))
```

## 与旧版本对比

### 主要改进

1. **新增状态筛选**: 支持materialMatchingStatus参数，可按新状态定义筛选
2. **价格比较逻辑**: 集成了表格价格与数据库价格的比较判断
3. **统计信息**: 响应中包含基于新状态定义的统计信息
4. **业务逻辑优化**: 筛选逻辑更贴近实际业务需求

### 迁移建议

```javascript
// 旧版本调用
fetch('/materials/partyb/query', {
    method: 'POST',
    body: JSON.stringify({
        taskId: 'task123',
        matchingStatus: 1 // 旧状态
    })
});

// 新版本调用
fetch('/materials/partyb/queryV2', {
    method: 'POST',
    body: JSON.stringify({
        taskId: 'task123',
        materialMatchingStatus: 1 // 新状态
    })
});
```

## 错误处理

### 错误响应格式

```json
{
    "code": 500,
    "message": "查询物资数据失败：具体错误信息",
    "data": null
}
```

### 常见错误

| 错误码 | 错误信息 | 解决方案 |
|-------|---------|----------|
| 400 | 任务ID不能为空 | 检查请求参数taskId |
| 400 | 页码不能小于0 | 检查page参数 |
| 400 | 每页大小不能小于1 | 检查size参数 |
| 500 | 查询物资数据失败 | 检查任务ID是否存在，联系技术支持 |

## 使用示例

### 基础查询

```javascript
const queryMaterials = async (taskId, page = 0, size = 10) => {
    try {
        const response = await fetch('/materials/partyb/queryV2', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                taskId,
                page,
                size
            })
        });

        const data = await response.json();
        console.log('查询结果:', data);
        return data;
    } catch (error) {
        console.error('查询失败:', error);
        throw error;
    }
};
```

### 按状态筛选

```javascript
const queryByStatus = async (taskId, status) => {
    return await fetch('/materials/partyb/queryV2', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            taskId,
            materialMatchingStatus: status,
            page: 0,
            size: 20
        })
    }).then(response => response.json());
};

// 查询精确匹配的物资
const exactMatches = await queryByStatus('task123', 1);

// 查询待确认的物资
const pendingConfirmation = await queryByStatus('task123', 2);

// 查询待处理的物资
const pendingProcessing = await queryByStatus('task123', 3);
```

### 关键词搜索

```javascript
const searchMaterials = async (taskId, keyword) => {
    return await fetch('/materials/partyb/queryV2', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            taskId,
            keyword,
            page: 0,
            size: 50
        })
    }).then(response => response.json());
};

// 搜索钢筋相关物资
const steelMaterials = await searchMaterials('task123', '钢筋');
```

## 性能优化建议

1. **分页查询**: 建议使用合理的分页大小，避免一次查询过多数据
2. **精确筛选**: 使用具体的筛选条件减少查询范围
3. **关键词优化**: 关键词搜索建议3个字符以上，提高查询效率
4. **缓存策略**: 可对查询结果进行适当缓存

## 注意事项

1. **状态理解**: 确保正确理解新状态定义的业务含义
2. **前端适配**: 前端需要根据新状态调整界面展示逻辑
3. **数据一致性**: 查询结果与统计接口保持逻辑一致
4. **向后兼容**: 旧版本接口仍可使用，但建议迁移到新版本

## 更新历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.3.3 | 2024-XX-XX | 初始版本，基于新状态定义逻辑，新增materialMatchingStatus筛选参数 |