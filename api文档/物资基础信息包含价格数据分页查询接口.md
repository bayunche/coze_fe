# 物资基础信息包含价格数据分页查询接口

## 接口信息
- **接口路径**: `GET /api/materials/base-info/search-with-prices`
- **接口描述**: 搜索物资基础信息并返回每个物资下的价格数据列表，支持分页查询
- **请求方式**: GET
- **Content-Type**: application/json

## 请求参数

### 查询参数 (Query Parameters)
| 参数名称 | 类型 | 必填 | 默认值 | 说明 |
|---------|------|------|-------|------|
| keyword | String | 否 | - | 搜索关键字，可以为空。搜索范围包括物资名称、规格型号、单位、物资编码、序列号 |
| page | Integer | 否 | 0 | 页码，从0开始 |
| size | Integer | 否 | 10 | 每页记录数 |

### 请求示例
```
GET /api/materials/base-info/search-with-prices?keyword=钢材&page=0&size=10
```

## 响应结果

### 成功响应
```json
{
  "content": [
    {
      "materialBaseInfo": {
        "id": "material-base-id-001",
        "bstudioCreateTime": "2023-10-27T10:30:00",
        "materialName": "Q235B钢材",
        "specificationModel": "200*300*12",
        "unit": "吨",
        "serialNumber": "GC001",
        "priceCode": "PC001",
        "materialCode": "MC001",
        "businessDomain": "CONTRACT",
        "mainDistributionNetwork": "主网",
        "mainDistributionType": 1,
        "type": "结构钢材"
      },
      "priceList": [
        {
          "id": "price-id-001",
          "baseInfoId": "material-base-id-001",
          "quarter": "2023-Q4",
          "taxPrice": 4520.50
        },
        {
          "id": "price-id-002",
          "baseInfoId": "material-base-id-001",
          "quarter": "2023-Q3",
          "taxPrice": 4380.00
        },
        {
          "id": "price-id-003",
          "baseInfoId": "material-base-id-001",
          "quarter": "2023-Q2",
          "taxPrice": 4250.75
        }
      ]
    },
    {
      "materialBaseInfo": {
        "id": "material-base-id-002",
        "bstudioCreateTime": "2023-10-25T14:20:00",
        "materialName": "16Mn钢材",
        "specificationModel": "150*250*10",
        "unit": "吨",
        "serialNumber": "GC002",
        "priceCode": "PC002",
        "materialCode": "MC002",
        "businessDomain": "CONTRACT",
        "mainDistributionNetwork": "配网",
        "mainDistributionType": 2,
        "type": "合金钢材"
      },
      "priceList": [
        {
          "id": "price-id-004",
          "baseInfoId": "material-base-id-002",
          "quarter": "2023-Q4",
          "taxPrice": 5120.00
        },
        {
          "id": "price-id-005",
          "baseInfoId": "material-base-id-002",
          "quarter": "2023-Q3",
          "taxPrice": 4980.25
        }
      ]
    }
  ],
  "pageable": {
    "sort": {
      "empty": false,
      "sorted": true,
      "unsorted": false
    },
    "offset": 0,
    "pageSize": 10,
    "pageNumber": 0,
    "paged": true,
    "unpaged": false
  },
  "last": false,
  "totalPages": 5,
  "totalElements": 42,
  "size": 10,
  "number": 0,
  "sort": {
    "empty": false,
    "sorted": true,
    "unsorted": false
  },
  "first": true,
  "numberOfElements": 2,
  "empty": false
}
```

### 错误响应
```json
{
  "timestamp": "2023-10-27T10:30:00.000+00:00",
  "status": 500,
  "error": "Internal Server Error",
  "message": "查询失败：具体错误信息",
  "path": "/api/materials/base-info/search-with-prices"
}
```

## 响应字段说明

### MaterialBaseInfoWithPricesVO 结构
| 字段名称 | 类型 | 说明 |
|---------|------|------|
| materialBaseInfo | MaterialBaseInfoDO | 物资基础信息对象 |
| priceList | List&lt;TaxPriceDO&gt; | 该物资下的价格数据列表，按季度降序排序 |

### MaterialBaseInfoDO 字段说明
| 字段名称 | 类型 | 说明 |
|---------|------|------|
| id | String | 主键ID |
| bstudioCreateTime | LocalDateTime | 数据插入时间 |
| materialName | String | 设备材料名称 |
| specificationModel | String | 规格型号 |
| unit | String | 单位 |
| serialNumber | String | 序号 |
| priceCode | String | 信息价编码 |
| materialCode | String | 物资编码 |
| businessDomain | String | 业务域（CONTRACT/J_MATERIAL/Y_MATERIAL） |
| mainDistributionNetwork | String | 主/配标识 |
| mainDistributionType | Integer | 主/配类型（1:主网、2:配网、3:深圳市地材价） |
| type | String | 物资类型 |

### TaxPriceDO 字段说明
| 字段名称 | 类型 | 说明 |
|---------|------|------|
| id | String | 价格记录主键ID |
| baseInfoId | String | 关联基础信息表ID |
| quarter | String | 季度（格式：YYYY-Q#，如2023-Q4） |
| taxPrice | BigDecimal | 含税价（精度15位，小数4位） |

## 测试用例

### 1. 无关键字搜索（返回所有记录）
```bash
curl -X GET "http://localhost:1207/api/materials/base-info/search-with-prices?page=0&size=5"
```

### 2. 关键字搜索
```bash
curl -X GET "http://localhost:1207/api/materials/base-info/search-with-prices?keyword=钢材&page=0&size=10"
```

### 3. 多字段关键字搜索
```bash
curl -X GET "http://localhost:1207/api/materials/base-info/search-with-prices?keyword=Q235B&page=0&size=10"
```

### 4. 分页测试
```bash
# 第1页，每页5条
curl -X GET "http://localhost:1207/api/materials/base-info/search-with-prices?keyword=钢材&page=0&size=5"

# 第2页，每页5条
curl -X GET "http://localhost:1207/api/materials/base-info/search-with-prices?keyword=钢材&page=1&size=5"
```

### 5. 单位关键字搜索
```bash
curl -X GET "http://localhost:1207/api/materials/base-info/search-with-prices?keyword=吨&page=0&size=10"
```

## 业务逻辑说明

### 搜索逻辑
1. **多字段模糊搜索**: 关键字会在以下字段中进行模糊匹配（使用LIKE查询）：
   - materialName（物资名称）
   - specificationModel（规格型号）
   - unit（单位）
   - serialNumber（序列号）
   - materialCode（物资编码）
2. **OR条件连接**: 只要任一字段匹配关键字即返回该记录
3. **空关键字处理**: 如果keyword为空或null，返回所有记录

### 价格数据关联
1. **查询流程**: 
   - 首先执行物资基础信息的分页查询
   - 对每个查询到的物资基础信息，查询其对应的价格数据列表
   - 价格数据按季度降序排序（最新季度在前）
2. **数据组装**: 将物资基础信息和价格列表组装成MaterialBaseInfoWithPricesVO对象
3. **分页保持**: 保持原有的分页结构，总页数和总记录数基于物资基础信息

### 性能优化
1. **Stream操作**: 使用Java 8 Stream API进行数据转换，提高代码可读性
2. **按需查询**: 只为查询结果中的物资查询价格数据，避免不必要的数据库查询
3. **排序优化**: 价格数据在DAO层排序，减少内存排序操作

## 注意事项

1. **分页基于物资数量**: 分页是基于物资基础信息的数量，不是基于价格记录的数量
2. **价格数据可能为空**: 某些物资可能没有价格数据，priceList可能为空列表
3. **季度格式**: 季度字段格式为"YYYY-Q#"，如"2023-Q4"
4. **价格精度**: 含税价使用BigDecimal类型，支持15位精度，4位小数
5. **业务域枚举**: businessDomain字段值限定为CONTRACT、J_MATERIAL、Y_MATERIAL
6. **主配类型**: mainDistributionType字段值限定为1（主网）、2（配网）、3（深圳市地材价）
7. **性能考虑**: 大量数据查询时，建议合理设置分页大小，避免单次查询返回过多数据

## 与原接口的区别

### 原接口 (`/search`)
- **返回**: `Page<MaterialBaseInfoDO>`
- **数据**: 仅包含物资基础信息
- **用途**: 基础的物资信息查询

### 新接口 (`/search-with-prices`)
- **返回**: `Page<MaterialBaseInfoWithPricesVO>`
- **数据**: 包含物资基础信息 + 价格数据列表
- **用途**: 需要同时展示物资信息和历史价格的场景
- **额外特性**: 价格数据按季度降序排序，便于查看最新价格信息

## 使用场景

1. **物资询价**: 查看物资的历史价格趋势
2. **成本分析**: 分析不同季度的价格变化
3. **预算编制**: 基于历史价格制定预算
4. **采购决策**: 参考历史价格进行采购决策
5. **价格监控**: 监控物资价格的季度变化趋势