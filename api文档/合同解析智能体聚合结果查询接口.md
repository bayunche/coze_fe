# 合同解析智能体聚合结果查询接口

## 接口信息
- **接口路径**: `GET /api/contract/analysis-results/task/{taskId}`
- **接口描述**: 根据任务ID获取聚合的合同解析结果，将同一任务下的解析结果按记录ID聚合，每个记录的多个字段组合成JSON对象
- **请求方式**: GET
- **Content-Type**: application/json

## 请求参数

### 路径参数 (Path Parameters)
| 参数名称 | 类型 | 必填 | 说明 |
|---------|------|------|------|
| taskId | String | 是 | 任务ID，用于查询该任务下的所有解析结果 |

### 请求示例
```
GET /api/contract/analysis-results/task/task-123456
```

## 响应结果

### 成功响应
```json
{
  "resultJson": [
    {
      "id": "analysis-record-001",
      "resultStatus": 1,
      "docJson": {
        "contract_name": "设备采购合同",
        "contract_amount": "1000000.00",
        "contract_party_a": "ABC公司",
        "contract_party_b": "XYZ供应商",
        "signing_date": "2023-10-27",
        "contract_type": "采购合同",
        "delivery_date": "2023-12-31"
      }
    },
    {
      "id": "analysis-record-002", 
      "resultStatus": 0,
      "docJson": {
        "contract_name": "服务外包合同",
        "contract_amount": "500000.00",
        "contract_party_a": "DEF公司",
        "contract_party_b": "GHI服务商",
        "signing_date": "2023-10-25",
        "contract_type": "服务合同",
        "service_period": "12个月"
      }
    }
  ]
}
```

### 空结果响应
```json
{
  "resultJson": []
}
```

### 错误响应
```json
{
  "timestamp": "2023-10-27T10:30:00.000+00:00",
  "status": 500,
  "error": "Internal Server Error",
  "message": "获取合同解析聚合结果失败：具体错误信息",
  "path": "/api/contract/analysis-results/task/task-123456"
}
```

## 响应字段说明

### ContractAnalysisResultVO 结构
| 字段名称 | 类型 | 说明 |
|---------|------|------|
| resultJson | List&lt;ContractAnalysisAggregatedVO&gt; | 聚合后的解析结果列表 |

### ContractAnalysisAggregatedVO 字段说明
| 字段名称 | 类型 | 说明 |
|---------|------|------|
| id | String | 解析记录ID，对应wmes_analysis_results表的ID字段 |
| resultStatus | Integer | 解析结果状态（0：未确认、1：已确认） |
| docJson | Map&lt;String, String&gt; | 解析字段JSON对象，key为column_code，value为column_value |

### docJson 动态字段说明
docJson中的字段根据智能体解析的实际内容动态生成，常见字段包括：

| 字段编码 | 字段名称 | 说明 | 示例值 |
|---------|---------|------|--------|
| contract_name | 合同名称 | 解析出的合同标题 | "设备采购合同" |
| contract_amount | 合同金额 | 合同总金额 | "1000000.00" |
| contract_party_a | 甲方 | 合同甲方名称 | "ABC公司" |
| contract_party_b | 乙方 | 合同乙方名称 | "XYZ供应商" |
| signing_date | 签署日期 | 合同签署日期 | "2023-10-27" |
| contract_type | 合同类型 | 合同分类 | "采购合同" |
| delivery_date | 交付日期 | 货物交付日期 | "2023-12-31" |
| service_period | 服务周期 | 服务合同的服务期限 | "12个月" |

**注意**：docJson中的具体字段取决于智能体的解析配置和合同内容，上述字段仅为示例。

## 等效SQL查询
该接口实现的功能等同于以下SQL查询：

```sql
SELECT JSON_ARRAYAGG(
  JSON_MERGE_PRESERVE(
    JSON_OBJECT('id', id, 'result_status', result_status),
    doc_json
  )
) AS result_json  
FROM (
  SELECT 
    id,
    MAX(result_status) AS result_status,
    JSON_OBJECTAGG(column_code, column_value) AS doc_json
  FROM wmes_analysis_results
  WHERE task_id = 'task-123456'
  GROUP BY id
) t;
```

## 业务逻辑说明

### 聚合逻辑
1. **按记录ID分组**: 将同一任务下的所有解析结果按记录ID（wmes_analysis_results.id）进行分组
2. **字段聚合**: 每个记录ID下的多行数据（不同的column_code和column_value）合并为一个JSON对象
3. **状态处理**: 取每个记录ID下result_status的最大值（避免聚合冲突）
4. **JSON构建**: 将记录的基本信息（id、result_status）与解析字段JSON合并

### 双重实现机制
接口采用双重实现确保高可用性：

1. **优先使用原生SQL**: 直接在数据库层执行JSON聚合，性能更优
2. **Java端聚合备选**: 如果原生SQL失败，采用Java代码进行数据聚合

### 数据处理流程
1. **参数验证**: 检查taskId是否为空
2. **数据查询**: 根据taskId查询相关的解析结果
3. **数据聚合**: 按记录ID分组并构建JSON对象
4. **结果返回**: 封装为标准响应格式

## 测试用例

### 1. 正常查询测试
```bash
curl -X GET "http://localhost:1207/api/contract/analysis-results/task/task-123456"
```

### 2. 不存在的任务ID测试
```bash
curl -X GET "http://localhost:1207/api/contract/analysis-results/task/non-existent-task"
```

### 3. 空任务ID测试（应返回400错误）
```bash
curl -X GET "http://localhost:1207/api/contract/analysis-results/task/"
```

### 4. 无效任务ID格式测试
```bash
curl -X GET "http://localhost:1207/api/contract/analysis-results/task/invalid@task#id"
```

## 性能考虑

### 数据库优化
- **索引建议**: 在`wmes_analysis_results`表的`task_id`字段上建立索引
- **分页处理**: 如果单个任务的解析结果过多，考虑客户端分页展示
- **缓存策略**: 对于已确认的解析结果，可考虑缓存机制

### 查询优化
- **原生SQL优先**: 优先使用MySQL的JSON函数进行数据库层聚合
- **连接池**: 使用HikariCP连接池优化数据库连接
- **超时设置**: 设置合理的查询超时时间

## 错误码说明

| HTTP状态码 | 错误类型 | 可能原因 | 解决方案 |
|-----------|---------|---------|---------|
| 400 | Bad Request | taskId参数为空或格式错误 | 检查请求URL中的taskId参数 |
| 404 | Not Found | 指定的任务ID不存在 | 确认任务ID是否正确 |
| 500 | Internal Server Error | 数据库连接错误或查询失败 | 检查数据库连接状态，查看服务器日志 |

## 使用场景

1. **合同信息展示**: 在前端页面展示解析出的合同关键信息
2. **结果确认流程**: 用户查看和确认智能体解析的合同内容
3. **数据导出**: 将解析结果导出为结构化数据
4. **审计追踪**: 查看特定任务的完整解析历史
5. **质量检查**: 对比原始合同与解析结果，进行质量评估

## 日志追踪

接口使用MDC（Mapped Diagnostic Context）进行请求追踪：
- **traceId**: 每个请求生成唯一的追踪ID
- **日志格式**: 所有相关日志都包含traceId，便于问题排查
- **性能监控**: 记录查询耗时和数据量统计

## 安全说明

- **参数验证**: 严格验证taskId参数，防止SQL注入
- **权限控制**: 确保用户只能查询自己权限范围内的任务结果
- **敏感信息**: 解析结果可能包含敏感的合同信息，注意数据安全
- **日志脱敏**: 避免在日志中记录敏感的合同内容

## 注意事项

1. **数据一致性**: 解析结果可能在不同时间点被修改，注意数据的时效性
2. **JSON字段**: docJson中的字段完全依赖于智能体的解析配置，可能会变化
3. **结果状态**: resultStatus为0表示未确认，需要人工审核；为1表示已确认
4. **数据量**: 单个任务可能包含大量解析记录，注意内存使用
5. **编码格式**: 确保返回的中文内容正确编码，避免乱码问题