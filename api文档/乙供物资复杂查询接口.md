# 乙供物资复杂查询接口

## 接口信息
- **接口路径**: `POST /materials/partyb/query`
- **接口描述**: 复杂查询乙供物资解析结果，支持分页、筛选、搜索功能，返回包含完整物资信息、价格信息和匹配选项的查询结果
- **请求方式**: POST  
- **Content-Type**: application/json

## 请求参数

### 请求体参数 (Request Body)
| 参数名称 | 类型 | 必填 | 默认值 | 说明 |
|---------|------|------|-------|------|
| taskId | String | 是 | - | 任务ID，用于查询该任务下的所有物资数据 |
| page | Integer | 否 | 0 | 页码（从0开始） |
| size | Integer | 否 | 10 | 每页大小 |
| keyword | String | 否 | - | 搜索关键词，支持物资名称、规格型号、单位的模糊搜索 |
| confirmResult | Integer | 否 | - | 确认结果筛选（0：未确认，1：已确认，不传则查询全部） |
| matchedType | Integer | 否 | - | 匹配类型筛选（0：无匹配，1：精确匹配，2：相似匹配，3：历史匹配，4：人工匹配，不传则查询全部） |

### 请求示例
```json
{
  "taskId": "task-123456",
  "page": 0,
  "size": 10,
  "keyword": "电缆",
  "confirmResult": 1,
  "matchedType": 1
}
```

## 响应结果

### 成功响应
```json
{
  "content": [
    {
      "taskDataId": "data-001",
      "taskId": "task-123456", 
      "taskDetailId": "detail-001",
      "materialName": "低压电力电缆",
      "specifications": "YJV-0.6/1kV-3×70+1×35",
      "unit": "米",
      "quantity": "1000",
      "unitPrice": "45.80",
      "totalPrice": "45800.00",
      "confirmResult": 1,
      "confirmBaseDataId": "base-001",
      "confirmPriceId": "price-001", 
      "confirmType": 1,
      "matchedType": 1,
      "baseInfo": {
        "baseDataId": "base-001",
        "materialName": "低压电力电缆",
        "specifications": "YJV-0.6/1kV-3×70+1×35",
        "unit": "米",
        "serialNumber": "001",
        "priceCode": "PC001",
        "materialCode": "MC001",
        "type": "电缆类"
      },
      "priceInfo": {
        "priceId": "price-001",
        "baseDataId": "base-001", 
        "taxPrice": "45.80",
        "quarter": "2023-Q4"
      },
      "matchOptions": [
        {
          "matchResultId": "match-001",
          "matchedId": "base-001",
          "matchScore": 95,
          "matchType": 1,
          "baseInfo": {
            "baseDataId": "base-001",
            "materialName": "低压电力电缆",
            "specifications": "YJV-0.6/1kV-3×70+1×35",
            "unit": "米",
            "serialNumber": "001",
            "priceCode": "PC001",
            "materialCode": "MC001",
            "type": "电缆类"
          },
          "priceOptions": [
            {
              "priceId": "price-001",
              "baseDataId": "base-001",
              "taxPrice": "45.80", 
              "quarter": "2023-Q4"
            },
            {
              "priceId": "price-002",
              "baseDataId": "base-001",
              "taxPrice": "43.20",
              "quarter": "2023-Q3"
            }
          ]
        }
      ]
    }
  ],
  "page": {
    "currentPage": 0,
    "pageSize": 10,
    "totalElements": 150,
    "totalPages": 15,
    "first": true,
    "last": false,
    "hasNext": true,
    "hasPrevious": false
  },
  "statistics": {
    "totalCount": 150,
    "confirmedCount": 85,
    "unconfirmedCount": 65,
    "exactMatchCount": 45,
    "similarMatchCount": 30,
    "historyMatchCount": 25,
    "manualMatchCount": 15,
    "noMatchCount": 35
  }
}
```

### 空结果响应
```json
{
  "content": [],
  "page": {
    "currentPage": 0,
    "pageSize": 10, 
    "totalElements": 0,
    "totalPages": 0,
    "first": true,
    "last": true,
    "hasNext": false,
    "hasPrevious": false
  },
  "statistics": {
    "totalCount": 0,
    "confirmedCount": 0,
    "unconfirmedCount": 0,
    "exactMatchCount": 0,
    "similarMatchCount": 0,
    "historyMatchCount": 0,
    "manualMatchCount": 0,
    "noMatchCount": 0
  }
}
```

### 错误响应
```json
{
  "timestamp": "2023-10-27T10:30:00.000+00:00",
  "status": 400,
  "error": "Bad Request", 
  "message": "任务ID不能为空",
  "path": "/materials/partyb/query"
}
```

## 响应字段说明

### MaterialQueryResponseVO 结构
| 字段名称 | 类型 | 说明 |
|---------|------|------|
| content | List&lt;MaterialQueryResultVO&gt; | 查询结果列表 |
| page | PageInfo | 分页信息 |
| statistics | StatisticsInfo | 统计信息 |

### MaterialQueryResultVO 字段说明
| 字段名称 | 类型 | 说明 |
|---------|------|------|
| taskDataId | String | 任务数据ID |
| taskId | String | 任务ID |
| taskDetailId | String | 任务详情ID |
| materialName | String | 解析出的物资名称 |
| specifications | String | 解析出的规格型号 |
| unit | String | 解析出的单位 |
| quantity | String | 解析出的数量 |
| unitPrice | String | 解析出的单价 |
| totalPrice | String | 解析出的总价 |
| confirmResult | Integer | 确认结果（0：未确认，1：已确认） |
| confirmBaseDataId | String | 确认的基础数据ID |
| confirmPriceId | String | 确认的价格ID |
| confirmType | Integer | 确认类型（1：默认推荐确认，2：从待选列表选择确认，3：人工选择数据确认） |
| matchedType | Integer | 匹配类型（0：无匹配，1：精确匹配，2：相似匹配，3：历史匹配，4：人工匹配） |
| baseInfo | MaterialBaseInfoVO | 匹配的基础数据信息 |
| priceInfo | MaterialPriceInfoVO | 匹配的价格信息 |
| matchOptions | List&lt;MaterialMatchOptionVO&gt; | 可选的匹配结果列表 |

### MaterialBaseInfoVO 字段说明
| 字段名称 | 类型 | 说明 |
|---------|------|------|
| baseDataId | String | 基础数据ID |
| materialName | String | 物资名称 |
| specifications | String | 规格型号 |
| unit | String | 单位 |
| serialNumber | String | 序号 |
| priceCode | String | 信息价编码 |
| materialCode | String | 物资编码 |
| type | String | 物资类型 |

### MaterialPriceInfoVO 字段说明
| 字段名称 | 类型 | 说明 |
|---------|------|------|
| priceId | String | 价格ID |
| baseDataId | String | 基础数据ID |
| taxPrice | String | 含税单价 |
| quarter | String | 价格季度（格式：YYYY-Q#） |

### MaterialMatchOptionVO 字段说明
| 字段名称 | 类型 | 说明 |
|---------|------|------|
| matchResultId | String | 匹配结果ID |
| matchedId | String | 匹配的基础数据ID |
| matchScore | Integer | 匹配分数（0-100） |
| matchType | Integer | 匹配类型（1：精确匹配，2：相似匹配，3：历史匹配） |
| baseInfo | MaterialBaseInfoVO | 基础数据信息 |
| priceOptions | List&lt;MaterialPriceInfoVO&gt; | 可用价格列表（最多5个，按季度降序） |

### PageInfo 分页信息
| 字段名称 | 类型 | 说明 |
|---------|------|------|
| currentPage | Integer | 当前页码（从0开始） |
| pageSize | Integer | 每页大小 |
| totalElements | Long | 总记录数 |
| totalPages | Integer | 总页数 |
| first | Boolean | 是否为第一页 |
| last | Boolean | 是否为最后一页 |
| hasNext | Boolean | 是否有下一页 |
| hasPrevious | Boolean | 是否有上一页 |

### StatisticsInfo 统计信息
| 字段名称 | 类型 | 说明 |
|---------|------|------|
| totalCount | Long | 总记录数 |
| confirmedCount | Long | 已确认数量 |
| unconfirmedCount | Long | 未确认数量 |
| exactMatchCount | Long | 精确匹配数量 |
| similarMatchCount | Long | 相似匹配数量 |
| historyMatchCount | Long | 历史匹配数量 |
| manualMatchCount | Long | 人工匹配数量 |
| noMatchCount | Long | 无匹配数量 |

## 等效SQL查询

该接口实现的功能等同于以下复杂SQL查询：

```sql
SELECT 
JSON_ARRAYAGG(
  JSON_OBJECT(
    'taskDataId', t.id,
    'taskId', t.task_id,
    'taskDetailId', t.task_detail_id,
    'materialName', t.material_name,
    'specifications', t.specification_model,
    'unit', t.unit,
    'quantity', t.count,
    'unitPrice', t.tax_price,
    'totalPrice', t.price,
    'confirmResult', t.confirm_result,
    'confirmBaseDataId', t.confirm_base_data_id,
    'confirmPriceId', t.confirm_price_id,
    'confirmType', t.confirm_type,
    'matchedType', t.comparison_result,
    'baseInfo', base_info.base_json,
    'priceInfo', price_info.price_json,
    'matchOptions', match_options.match_json
  )
) as result_json 
FROM wmes_y_materail_task_data t 
LEFT JOIN LATERAL (
  -- 基础信息子查询
  SELECT JSON_OBJECT(
    'baseDataId', b.id,
    'materialName', b.material_name,
    'specifications', b.specification_model,
    'unit', b.unit,
    'serialNumber', b.serial_number,
    'priceCode', b.price_code,
    'materialCode', b.material_code,
    'type', b.type
  ) as base_json 
  FROM wmes_material_base_info b 
  WHERE b.id = t.confirm_base_data_id 
  LIMIT 1
) base_info ON TRUE 
LEFT JOIN LATERAL (
  -- 价格信息子查询
  SELECT JSON_OBJECT(
    'priceId', p.id,
    'baseDataId', p.base_info_id,
    'taxPrice', p.tax_price,
    'quarter', p.quarter
  ) as price_json 
  FROM wmes_tax_price p 
  WHERE p.id = t.confirm_price_id 
  LIMIT 1
) price_info ON TRUE 
LEFT JOIN LATERAL (
  -- 匹配选项子查询
  SELECT JSON_ARRAYAGG(
    JSON_OBJECT(
      'matchResultId', m.id,
      'matchedId', m.matched_id,
      'matchScore', m.score,
      'matchType', m.matched_type,
      'baseInfo', JSON_OBJECT(
        'baseDataId', mb.id,
        'materialName', mb.material_name,
        'specifications', mb.specification_model,
        'unit', mb.unit,
        'serialNumber', mb.serial_number,
        'priceCode', mb.price_code,
        'materialCode', mb.material_code,
        'type', mb.type
      ),
      'priceOptions', (
        SELECT JSON_ARRAYAGG(
          JSON_OBJECT(
            'priceId', tp.id,
            'baseDataId', tp.base_info_id,
            'taxPrice', tp.tax_price,
            'quarter', tp.quarter
          )
        )
        FROM wmes_tax_price tp 
        WHERE tp.base_info_id = mb.id 
        ORDER BY tp.quarter DESC 
        LIMIT 5
      )
    )
  ) as match_json 
  FROM wmes_y_materail_matched_result m 
  LEFT JOIN wmes_material_base_info mb ON mb.id = m.matched_id 
  WHERE m.y_materauk_task_data_id = t.id 
  ORDER BY m.score DESC 
  LIMIT 10
) match_options ON TRUE 
WHERE t.task_id = ? 
AND (? IS NULL OR ? = '' OR 
     t.material_name LIKE CONCAT('%', ?, '%') OR 
     t.specification_model LIKE CONCAT('%', ?, '%') OR 
     t.unit LIKE CONCAT('%', ?, '%')) 
AND (? IS NULL OR t.confirm_result = ?) 
AND (? IS NULL OR t.comparison_result = ?) 
ORDER BY t.id ASC 
LIMIT ? OFFSET ?;
```

## 业务逻辑说明

### 查询逻辑
1. **主数据查询**: 从`wmes_y_materail_task_data`表查询指定任务的所有物资数据
2. **关联查询**: 使用LATERAL JOIN技术关联基础信息、价格信息和匹配选项
3. **分页处理**: 支持基于偏移量的分页查询
4. **筛选条件**: 支持多维度筛选（确认状态、匹配类型、关键词搜索）
5. **统计计算**: 并行查询各类型统计数据

### 性能优化设计
1. **JSON聚合**: 使用MySQL JSON函数在数据库层面进行数据聚合，减少网络传输
2. **LATERAL JOIN**: 避免传统JOIN的笛卡尔积问题，提升查询性能
3. **限制子查询**: 匹配选项限制10个，价格选项限制5个，避免数据量过大
4. **索引友好**: 查询条件设计便于利用数据库索引

### 匹配类型说明
- **0 (无匹配)**: 未找到任何匹配的基础数据
- **1 (精确匹配)**: 物资名称、规格型号、单位完全匹配
- **2 (相似匹配)**: 通过向量库或模糊匹配找到的相似物资  
- **3 (历史匹配)**: 基于历史确认记录找到的匹配
- **4 (人工匹配)**: 用户手动选择和确认的匹配

### 确认类型说明
- **1 (默认推荐确认)**: 用户确认了系统推荐的第一个匹配结果
- **2 (从待选列表选择确认)**: 用户从匹配选项列表中选择了其他选项
- **3 (人工选择数据确认)**: 用户手动输入或选择了不在匹配列表中的数据

## 测试用例

### 1. 基本查询测试
```bash
curl -X POST "http://localhost:1207/materials/partyb/query" \
  -H "Content-Type: application/json" \
  -d '{
    "taskId": "task-123456",
    "page": 0,
    "size": 10
  }'
```

### 2. 关键词搜索测试
```bash
curl -X POST "http://localhost:1207/materials/partyb/query" \
  -H "Content-Type: application/json" \
  -d '{
    "taskId": "task-123456",
    "keyword": "电缆",
    "page": 0,
    "size": 5
  }'
```

### 3. 筛选条件测试
```bash
curl -X POST "http://localhost:1207/materials/partyb/query" \
  -H "Content-Type: application/json" \
  -d '{
    "taskId": "task-123456",
    "confirmResult": 1,
    "matchedType": 1,
    "page": 0,
    "size": 10
  }'
```

### 4. 大分页测试
```bash
curl -X POST "http://localhost:1207/materials/partyb/query" \
  -H "Content-Type: application/json" \
  -d '{
    "taskId": "task-123456",
    "page": 10,
    "size": 50
  }'
```

### 5. 参数验证测试（应返回400错误）
```bash
curl -X POST "http://localhost:1207/materials/partyb/query" \
  -H "Content-Type: application/json" \
  -d '{
    "page": 0,
    "size": 10
  }'
```

## 性能考虑

### 数据库优化
- **索引建议**: 
  - `wmes_y_materail_task_data(task_id)` - 主查询索引
  - `wmes_y_materail_task_data(task_id, confirm_result)` - 筛选索引
  - `wmes_y_materail_task_data(task_id, comparison_result)` - 匹配类型索引
  - `wmes_y_materail_matched_result(y_materauk_task_data_id, score)` - 匹配结果索引
  - `wmes_tax_price(base_info_id, quarter)` - 价格查询索引

### 查询优化
- **分页策略**: 使用LIMIT + OFFSET，适合小到中等数据量的分页
- **JSON聚合**: 在数据库层完成复杂数据组装，减少应用层处理
- **子查询限制**: 合理限制子查询返回数量，避免单条记录数据过大

### 内存使用
- **结果集控制**: 通过合理的分页大小控制内存使用
- **连接池**: 使用HikariCP连接池优化数据库连接管理
- **JSON解析**: 使用Jackson流式解析，降低内存峰值

## 错误码说明

| HTTP状态码 | 错误类型 | 可能原因 | 解决方案 |
|-----------|---------|---------|---------| 
| 400 | Bad Request | 请求参数错误（如taskId为空） | 检查请求参数格式和必填项 |
| 500 | Internal Server Error | 数据库连接错误或SQL执行失败 | 检查数据库连接状态和SQL语法 |
| 500 | Internal Server Error | JSON解析失败 | 检查数据库返回的JSON格式 |

## 使用场景

1. **物资管理界面**: 展示任务下所有物资的解析和匹配状态
2. **确认工作流**: 用户查看待确认的物资匹配结果
3. **统计报表**: 基于统计信息生成各类匹配状态报表
4. **数据导出**: 将查询结果导出为Excel或其他格式
5. **质量检查**: 审核人员检查物资解析和匹配的准确性

## 日志追踪

接口使用MDC（Mapped Diagnostic Context）进行请求追踪：
- **traceId**: 每个请求生成唯一的追踪ID格式为`queryMaterials_${UUID}`
- **日志格式**: 所有相关日志都包含traceId，便于问题排查
- **性能监控**: 记录查询耗时和返回数据量统计
- **错误处理**: 详细记录查询失败的具体原因和堆栈信息

## 安全说明

- **参数验证**: 使用@Valid注解进行请求参数验证，防止无效输入
- **SQL注入防护**: 使用JPA的@Query注解和参数绑定，避免SQL注入
- **权限控制**: 建议在Controller层添加权限验证，确保用户只能查询授权范围内的任务
- **敏感信息**: 价格等敏感信息需要根据业务需求进行脱敏处理
- **日志脱敏**: 避免在日志中记录敏感的物资价格信息

## 注意事项

1. **数据一致性**: 查询结果反映的是查询时刻的数据状态，实时性受缓存和数据更新频率影响
2. **JSON字段**: 响应中的复杂JSON字段（baseInfo、priceInfo、matchOptions）可能为null，前端需要做空值处理
3. **匹配选项数量**: 每个物资最多返回10个匹配选项，按匹配分数降序排列
4. **价格选项数量**: 每个匹配选项最多返回5个价格记录，按季度降序排列
5. **分页性能**: 对于大偏移量的分页查询，可能存在性能问题，建议前端合理控制分页大小
6. **编码格式**: 确保请求和响应都使用UTF-8编码，避免中文内容乱码
7. **超时设置**: 复杂查询可能耗时较长，建议设置合适的请求超时时间（建议30秒以上）