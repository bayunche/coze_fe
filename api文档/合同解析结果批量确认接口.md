# 合同解析结果批量确认接口

## 接口信息
- **接口路径**: `POST /api/contract/analysis-results/confirm`
- **接口描述**: 批量确认指定任务下所有未确认的合同解析结果，将result_status从0更新为1，并更新修改时间
- **请求方式**: POST
- **Content-Type**: application/json

## 请求参数

### 请求体参数 (Request Body)
| 参数名称 | 类型 | 必填 | 说明 |
|---------|------|------|------|
| taskId | String | 是 | 任务ID，用于指定要确认的任务 |
| remark | String | 否 | 确认备注，可用于记录确认原因或说明 |

### 请求示例
```json
{
  "taskId": "task-123456",
  "remark": "人工审核完成，批量确认所有解析结果"
}
```

## 响应结果

### 成功响应
```json
{
  "taskId": "task-123456",
  "confirmedCount": 15,
  "previouslyConfirmedCount": 5,
  "newlyConfirmedCount": 10,
  "success": true,
  "message": "成功确认 10 条解析结果",
  "executedSql": "UPDATE wmes_analysis_results SET result_status = 1, updated_time = NOW() WHERE task_id = 'task-123456' AND result_status = 0"
}
```

### 无未确认记录响应
```json
{
  "taskId": "task-123456",
  "confirmedCount": 15,
  "previouslyConfirmedCount": 15,
  "newlyConfirmedCount": 0,
  "success": true,
  "message": "所有解析结果已经确认，无需重复操作",
  "executedSql": "UPDATE wmes_analysis_results SET result_status = 1, updated_time = NOW() WHERE task_id = 'task-123456' AND result_status = 0"
}
```

### 任务不存在响应
```json
{
  "taskId": "non-existent-task",
  "confirmedCount": 0,
  "previouslyConfirmedCount": 0,
  "newlyConfirmedCount": 0,
  "success": false,
  "message": "指定的任务不存在或没有解析结果",
  "executedSql": null
}
```

### 参数错误响应
```json
{
  "timestamp": "2023-10-27T10:30:00.000+00:00",
  "status": 400,
  "error": "Bad Request",
  "message": "任务ID不能为空",
  "path": "/api/contract/analysis-results/confirm"
}
```

### 系统错误响应
```json
{
  "taskId": "task-123456",
  "confirmedCount": 0,
  "previouslyConfirmedCount": 0,
  "newlyConfirmedCount": 0,
  "success": false,
  "message": "确认失败：数据库连接超时",
  "executedSql": null
}
```

## 响应字段说明

### ContractAnalysisConfirmResponseVO 字段说明
| 字段名称 | 类型 | 说明 |
|---------|------|------|
| taskId | String | 任务ID，与请求参数中的taskId一致 |
| confirmedCount | Integer | 确认操作完成后的总确认记录数 |
| previouslyConfirmedCount | Integer | 执行确认操作前已确认的记录数 |
| newlyConfirmedCount | Integer | 本次操作新确认的记录数 |
| success | Boolean | 操作是否成功执行 |
| message | String | 操作结果描述信息 |
| executedSql | String | 实际执行的SQL语句（调试用） |

### 字段关系说明
- `confirmedCount = previouslyConfirmedCount + newlyConfirmedCount`
- `newlyConfirmedCount` 表示本次操作实际更新的记录数
- 当 `newlyConfirmedCount = 0` 时，表示没有需要确认的记录

## 等效SQL操作

该接口等效于执行以下SQL语句：

```sql
-- 批量确认操作
UPDATE wmes_analysis_results 
SET result_status = 1, 
    updated_time = NOW() 
WHERE task_id = ? 
  AND result_status = 0;

-- 确认前统计查询
SELECT COUNT(*) as total_count 
FROM wmes_analysis_results 
WHERE task_id = ?;

SELECT COUNT(*) as confirmed_count 
FROM wmes_analysis_results 
WHERE task_id = ? AND result_status = 1;

SELECT COUNT(*) as unconfirmed_count 
FROM wmes_analysis_results 
WHERE task_id = ? AND result_status = 0;

-- 任务存在性检查
SELECT COUNT(*) > 0 as task_exists 
FROM wmes_analysis_results 
WHERE task_id = ?;
```

## 业务逻辑说明

### 确认流程
1. **参数验证**: 检查taskId是否为空，进行基础参数验证
2. **任务存在性检查**: 验证指定的任务是否存在解析结果
3. **状态统计**: 查询确认前的统计信息（总数、已确认数、未确认数）
4. **重复操作检查**: 如果没有未确认的记录，直接返回成功状态，避免无意义的数据库操作
5. **批量确认**: 执行UPDATE语句，将所有未确认记录更新为已确认状态
6. **结果构建**: 构建详细的响应信息，包含操作前后的统计数据

### 事务处理
- 使用`@Transactional`注解确保操作的原子性
- 如果确认过程中发生异常，所有更新操作会自动回滚
- 保证数据的一致性和完整性

### 幂等性设计
- 接口具有幂等性，多次调用相同参数的请求不会产生副作用
- 如果所有记录已经确认，再次调用返回成功状态，不会重复更新数据
- 通过检查未确认记录数量来避免无效的数据库操作

### 边界条件处理
1. **任务不存在**: 返回失败状态，提示任务不存在
2. **无解析结果**: 任务存在但没有解析结果，返回失败状态
3. **全部已确认**: 所有结果已确认，返回成功状态，不执行UPDATE
4. **部分确认**: 只确认未确认的记录，不影响已确认的记录
5. **数据库异常**: 捕获异常，返回失败状态和错误信息

## 测试用例

### 1. 正常确认测试
```bash
curl -X POST "http://localhost:1207/api/contract/analysis-results/confirm" \
  -H "Content-Type: application/json" \
  -d '{
    "taskId": "task-123456",
    "remark": "批量确认测试"
  }'
```

**预期结果**: 成功确认所有未确认的记录

### 2. 重复确认测试
```bash
# 第一次确认
curl -X POST "http://localhost:1207/api/contract/analysis-results/confirm" \
  -H "Content-Type: application/json" \
  -d '{"taskId": "task-123456"}'

# 立即再次确认同一任务
curl -X POST "http://localhost:1207/api/contract/analysis-results/confirm" \
  -H "Content-Type: application/json" \
  -d '{"taskId": "task-123456"}'
```

**预期结果**: 第一次返回确认的记录数，第二次返回已全部确认的状态

### 3. 不存在任务测试
```bash
curl -X POST "http://localhost:1207/api/contract/analysis-results/confirm" \
  -H "Content-Type: application/json" \
  -d '{
    "taskId": "non-existent-task-id"
  }'
```

**预期结果**: 返回失败状态，提示任务不存在

### 4. 参数验证测试
```bash
# 空taskId测试
curl -X POST "http://localhost:1207/api/contract/analysis-results/confirm" \
  -H "Content-Type: application/json" \
  -d '{
    "taskId": "",
    "remark": "空taskId测试"
  }'

# 缺少taskId测试
curl -X POST "http://localhost:1207/api/contract/analysis-results/confirm" \
  -H "Content-Type: application/json" \
  -d '{
    "remark": "缺少taskId测试"
  }'
```

**预期结果**: 返回400错误，提示taskId不能为空

### 5. 大批量确认测试
```bash
# 假设任务有1000条解析结果需要确认
curl -X POST "http://localhost:1207/api/contract/analysis-results/confirm" \
  -H "Content-Type: application/json" \
  -d '{
    "taskId": "large-task-id",
    "remark": "大批量确认测试"
  }'
```

**预期结果**: 成功确认所有记录，响应时间在可接受范围内

## 性能考虑

### 数据库优化
- **索引建议**: 
  - `wmes_analysis_results(task_id, result_status)` - 复合索引优化UPDATE条件
  - `wmes_analysis_results(task_id)` - 任务ID索引优化统计查询
  - `wmes_analysis_results(result_status)` - 状态索引优化状态统计

### 批量操作优化
- **单次UPDATE**: 使用单条UPDATE语句更新所有符合条件的记录，避免逐条更新
- **条件优化**: WHERE条件包含 `result_status = 0`，避免更新已确认的记录
- **事务控制**: 合理控制事务范围，避免长事务阻塞

### 内存使用
- **统计查询**: 只查询COUNT而不加载详细数据，减少内存使用
- **响应构建**: 构建轻量级响应对象，包含必要的统计信息
- **日志记录**: 合理控制日志输出量，避免大量日志影响性能

## 监控指标

### 关键指标
- **确认成功率**: 成功确认的请求占总请求的比例
- **平均确认记录数**: 每次确认操作涉及的平均记录数量  
- **响应时间**: 接口的平均响应时间和95%分位数响应时间
- **数据库更新性能**: UPDATE操作的执行时间统计

### 异常监控
- **任务不存在率**: 请求不存在任务的比例，可能表示上游系统问题
- **重复确认率**: 确认已确认任务的比例，可能表示业务流程问题
- **数据库异常率**: 数据库操作失败的比例，需要关注系统健康度

## 错误处理

| 状态码 | 错误类型 | 可能原因 | 解决方案 |
|--------|----------|----------|----------|
| 400 | Bad Request | taskId参数为空或格式错误 | 检查请求参数格式 |
| 500 | Internal Server Error | 数据库连接异常 | 检查数据库连接状态 |
| 500 | Internal Server Error | 事务执行失败 | 检查数据库事务配置和数据一致性 |
| 500 | Internal Server Error | 未知系统异常 | 查看应用日志定位具体问题 |

## 使用场景

1. **审核工作流**: 审核人员完成人工审核后，批量确认所有解析结果
2. **自动化流程**: 系统自动完成质量检查后，程序化确认解析结果  
3. **数据迁移**: 历史数据迁移完成后，批量确认导入的解析结果
4. **问题修复**: 修复解析问题后，重新确认受影响的解析结果
5. **定期维护**: 定期清理和确认积累的未确认解析结果

## 日志追踪

接口使用MDC进行请求追踪：
- **traceId**: 格式为 `confirmAnalysis_${UUID}` 的唯一追踪ID
- **日志级别**: 
  - INFO: 记录请求接收、确认前状态、确认完成等关键节点
  - WARN: 记录任务不存在、重复确认等业务警告
  - ERROR: 记录数据库异常、事务失败等系统错误
- **关键日志**: 包含taskId、确认记录数、操作结果等关键信息

## 安全说明

- **参数验证**: 使用@Valid注解进行请求参数验证
- **SQL注入防护**: 使用JPA的@Query注解和参数绑定，避免SQL注入风险
- **权限控制**: 建议添加用户权限验证，确保只有授权用户可以确认解析结果
- **操作审计**: 所有确认操作都有完整的日志记录，便于审计追踪
- **事务安全**: 使用数据库事务保证操作的原子性和一致性

## 注意事项

1. **不可逆操作**: 确认操作会永久改变数据状态，确认前请仔细验证
2. **批量影响**: 一次操作会影响指定任务下的所有未确认记录
3. **并发控制**: 多用户同时确认同一任务时，使用数据库行锁避免冲突
4. **数据一致性**: 确认操作会更新updated_time字段，确保数据时间戳正确
5. **业务流程**: 确认后的数据可能影响下游业务流程，需要考虑整体业务影响
6. **回滚策略**: 如需撤销确认操作，需要通过其他接口或数据库操作进行
7. **性能影响**: 大批量确认可能对数据库性能产生影响，建议在业务低峰期执行

## API版本说明

- **当前版本**: v3
- **向后兼容**: 该接口设计考虑了向后兼容性，未来版本升级不会破坏现有功能
- **废弃计划**: 暂无废弃计划，将持续维护和优化