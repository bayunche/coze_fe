# 合同解析结果修改确认接口

## 接口信息
- **接口路径**: `POST /api/contract/analysis-results/update`
- **接口描述**: 修改确认指定任务详情的合同解析结果，批量更新各字段的解析结果值，并设置为已确认状态
- **请求方式**: POST
- **Content-Type**: application/json

## 请求参数

### 请求体参数 (Request Body)
| 参数名称 | 类型 | 必填 | 说明 |
|---------|------|------|------|
| taskDetailId | String | 是 | 任务详情ID，用于指定要更新的任务详情 |
| resultStatus | Integer | 是 | 结果状态，设置为1表示已确认 |
| fieldData | List&lt;FieldDataVO&gt; | 是 | 要更新的字段数据列表，包含字段代码、字段名称和字段值 |
| remark | String | 否 | 更新备注，可用于记录修改原因或说明 |

### FieldDataVO 字段说明
| 参数名称 | 类型 | 必填 | 说明 |
|---------|------|------|------|
| columnCode | String | 是 | 字段代码，如 contract_name、signing_date 等 |
| columnName | String | 是 | 字段名称，如 "合同名称"、"签署日期" 等 |
| columnValue | String | 否 | 字段值，对应该字段的实际内容 |

### 请求示例
```json
{
  "taskDetailId": "a13161390c1d41b8a61f8215d17bc157",
  "resultStatus": 1,
  "fieldData": [
    {
      "columnCode": "contract_name",
      "columnName": "合同名称",
      "columnValue": "深圳供电局有限公司 2022-2023 年度变电管理一二所试验类项目框架招标"
    },
    {
      "columnCode": "signing_date",
      "columnName": "签署日期", 
      "columnValue": "2022年02月24日"
    },
    {
      "columnCode": "contract_number",
      "columnName": "合同编号",
      "columnValue": "0002200000086615"
    },
    {
      "columnCode": "contract_amount",
      "columnName": "合同金额",
      "columnValue": ""
    },
    {
      "columnCode": "fixed_rate",
      "columnName": "固定费率",
      "columnValue": ""
    },
    {
      "columnCode": "safety_rate", 
      "columnName": "安全费率",
      "columnValue": ""
    },
    {
      "columnCode": "temporary_rate",
      "columnName": "临时费率",
      "columnValue": ""
    }
  ],
  "remark": "人工修正解析结果并确认"
}
```

### fieldData 数组元素说明
- **columnCode**: 字段代码，用于标识数据库中的字段
- **columnName**: 字段名称，用于在创建新记录时设置可读的字段名称
- **columnValue**: 字段值，对应该字段的实际内容
- **空值处理**: 如果某个字段的值为空字符串，会将对应记录的 column_value 更新为空字符串

## 响应结果

### 成功响应（全部成功）
```json
{
  "taskDetailId": "a13161390c1d41b8a61f8215d17bc157",
  "success": true,
  "message": "成功处理 7 个字段，更新 5 条记录，创建 2 条新记录",
  "updatedFieldCount": 7,
  "updatedFields": [
    "contract_name",
    "signing_date", 
    "contract_number",
    "contract_amount",
    "fixed_rate",
    "safety_rate",
    "temporary_rate"
  ],
  "failedFields": null,
  "createdCount": 2,
  "actualUpdatedCount": 5,
  "existingCount": 5,
  "operationDetails": "请求更新 7 个字段，实际更新 5 条记录，创建 2 条新记录，失败 0 个字段"
}
```

### 部分成功响应
```json
{
  "taskDetailId": "a13161390c1d41b8a61f8215d17bc157",
  "success": false,
  "message": "部分成功：处理 5 个字段成功，2 个字段失败",
  "updatedFieldCount": 5,
  "updatedFields": [
    "contract_name",
    "signing_date",
    "contract_number",
    "contract_amount", 
    "fixed_rate"
  ],
  "failedFields": {
    "safety_rate": "更新失败，影响行数为0",
    "temporary_rate": "处理异常：数据库连接超时"
  },
  "createdCount": 1,
  "actualUpdatedCount": 4,
  "existingCount": 6,
  "operationDetails": "请求更新 7 个字段，实际更新 4 条记录，创建 1 条新记录，失败 2 个字段"
}
```

### 任务详情不存在响应
```json
{
  "taskDetailId": "non-existent-task-detail",
  "success": false,
  "message": "指定的任务详情不存在或没有解析结果",
  "updatedFieldCount": null,
  "updatedFields": null,
  "failedFields": null,
  "createdCount": null,
  "actualUpdatedCount": null,
  "existingCount": null,
  "operationDetails": null
}
```

### 参数错误响应
```json
{
  "timestamp": "2023-10-27T10:30:00.000+00:00",
  "status": 400,
  "error": "Bad Request",
  "message": "任务详情ID不能为空",
  "path": "/api/contract/analysis-results/update"
}
```

### 系统错误响应
```json
{
  "taskDetailId": "a13161390c1d41b8a61f8215d17bc157",
  "success": false,
  "message": "修改确认失败：数据库事务回滚",
  "updatedFieldCount": null,
  "updatedFields": null,
  "failedFields": null,
  "createdCount": null,
  "actualUpdatedCount": null,
  "existingCount": null,
  "operationDetails": null
}
```

## 响应字段说明

### ContractAnalysisUpdateResponseVO 字段说明
| 字段名称 | 类型 | 说明 |
|---------|------|------|
| taskDetailId | String | 任务详情ID，与请求参数中的taskDetailId一致 |
| success | Boolean | 操作是否完全成功（所有字段都处理成功） |
| message | String | 操作结果描述信息 |
| updatedFieldCount | Integer | 成功更新的字段数量 |
| updatedFields | List&lt;String&gt; | 成功更新的字段列表（column_code列表） |
| failedFields | Map&lt;String, String&gt; | 更新失败的字段信息，key为字段代码，value为失败原因 |
| createdCount | Integer | 新创建的记录数量 |
| actualUpdatedCount | Integer | 实际更新的数据库记录数 |
| existingCount | Integer | 处理前已存在的记录数量 |
| operationDetails | String | 详细的操作统计信息 |

### 字段关系说明
- `updatedFieldCount = updatedFields.size()` - 成功处理的字段数量
- `actualUpdatedCount + createdCount` - 总的数据库变更记录数
- `success = (failedFields == null || failedFields.isEmpty())` - 是否全部成功

## 等效SQL操作

该接口等效于执行以下SQL操作：

### 1. 检查任务详情存在性
```sql
SELECT COUNT(*) > 0 FROM wmes_analysis_results 
WHERE task_detail_id = ?;
```

### 2. 查询现有字段
```sql
SELECT DISTINCT column_code FROM wmes_analysis_results 
WHERE task_detail_id = ?;
```

### 3. 更新现有记录
```sql
UPDATE wmes_analysis_results 
SET column_value = ?, 
    result_status = ?, 
    updated_time = NOW() 
WHERE task_detail_id = ? 
  AND column_code = ?;
```

### 4. 获取任务ID（创建新记录时）
```sql
SELECT task_id FROM wmes_tasks_detail WHERE id = ?;
```

### 5. 创建新记录（如果不存在）
```sql
INSERT INTO wmes_analysis_results 
(task_detail_id, task_id, column_code, column_name, column_value, result_status, base_data_id, created_time, updated_time) 
VALUES (?, ?, ?, ?, ?, ?, NULL, NOW(), NOW());
```

## 业务逻辑说明

### 处理流程
1. **参数验证**: 检查taskDetailId、resultStatus和fieldData的有效性
2. **任务详情存在性检查**: 验证指定的任务详情是否存在解析结果
3. **现有记录统计**: 查询处理前的记录统计信息
4. **逐字段处理**: 对每个字段执行更新或创建操作
   - 如果记录存在，执行UPDATE操作
   - 如果记录不存在，执行INSERT操作
5. **结果统计**: 统计成功、失败的字段数量和详细信息
6. **响应构建**: 构建详细的操作结果响应

### 更新策略
- **存在记录**: 更新 `column_value`、`result_status` 和 `updated_time`
- **不存在记录**: 创建新记录，设置所有必要字段
  - `task_id`: 从 `wmes_tasks_detail` 表通过 `task_detail_id` 查询获得
  - `column_name`: 由前端传入并设置到新记录
  - `base_data_id`: 设置为 NULL，允许为空
- **空值处理**: 支持将字段值更新为空字符串
- **状态统一**: 所有处理的记录都会设置相同的 `result_status`

### 事务处理
- 使用 `@Transactional` 注解确保操作的原子性
- 如果任何操作发生异常，整个事务会回滚
- 单个字段的处理异常不会影响其他字段的处理

### 错误处理
- **字段级错误**: 单个字段处理失败不影响其他字段
- **系统级错误**: 数据库连接等系统问题会导致整体失败
- **详细错误信息**: 每个失败字段都会记录具体的失败原因

## 测试用例

### 1. 正常更新测试
```bash
curl -X POST "http://localhost:1207/api/contract/analysis-results/update" \
  -H "Content-Type: application/json" \
  -d '{
    "taskDetailId": "a13161390c1d41b8a61f8215d17bc157",
    "resultStatus": 1,
    "fieldData": [
      {
        "columnCode": "contract_name",
        "columnName": "合同名称",
        "columnValue": "深圳供电局合同"
      },
      {
        "columnCode": "signing_date",
        "columnName": "签署日期",
        "columnValue": "2022年02月24日"
      },
      {
        "columnCode": "contract_amount",
        "columnName": "合同金额",
        "columnValue": "1000000"
      }
    ],
    "remark": "人工修正测试"
  }'
```

**预期结果**: 成功更新指定字段的记录

### 2. 混合操作测试（更新+创建）
```bash
curl -X POST "http://localhost:1207/api/contract/analysis-results/update" \
  -H "Content-Type: application/json" \
  -d '{
    "taskDetailId": "a13161390c1d41b8a61f8215d17bc157",
    "resultStatus": 1,
    "fieldData": [
      {
        "columnCode": "contract_name",
        "columnName": "合同名称",
        "columnValue": "更新现有字段"
      },
      {
        "columnCode": "new_field",
        "columnName": "新增字段",
        "columnValue": "创建新字段"
      },
      {
        "columnCode": "contract_amount",
        "columnName": "合同金额",
        "columnValue": ""
      }
    ]
  }'
```

**预期结果**: 更新现有字段，创建新字段，处理空值

### 3. 空字段数据测试
```bash
curl -X POST "http://localhost:1207/api/contract/analysis-results/update" \
  -H "Content-Type: application/json" \
  -d '{
    "taskDetailId": "a13161390c1d41b8a61f8215d17bc157",
    "resultStatus": 1,
    "fieldData": []
  }'
```

**预期结果**: 返回400错误，提示字段数据不能为空

### 4. 不存在任务详情测试
```bash
curl -X POST "http://localhost:1207/api/contract/analysis-results/update" \
  -H "Content-Type: application/json" \
  -d '{
    "taskDetailId": "non-existent-task-detail",
    "resultStatus": 1,
    "fieldData": [
      {
        "columnCode": "contract_name",
        "columnName": "合同名称",
        "columnValue": "测试字段"
      }
    ]
  }'
```

**预期结果**: 返回失败状态，提示任务详情不存在

### 5. 参数验证测试
```bash
# 缺少taskDetailId
curl -X POST "http://localhost:1207/api/contract/analysis-results/update" \
  -H "Content-Type: application/json" \
  -d '{
    "resultStatus": 1,
    "fieldData": {
      "contract_name": "测试"
    }
  }'

# 缺少resultStatus  
curl -X POST "http://localhost:1207/api/contract/analysis-results/update" \
  -H "Content-Type: application/json" \
  -d '{
    "taskDetailId": "test-id",
    "fieldData": [
      {
        "columnCode": "contract_name",
        "columnName": "合同名称",
        "columnValue": "测试"
      }
    ]
  }'
```

**预期结果**: 返回400错误，提示必填参数缺失

### 6. 大批量字段更新测试
```bash
# 准备包含20个字段的请求
curl -X POST "http://localhost:1207/api/contract/analysis-results/update" \
  -H "Content-Type: application/json" \
  -d '{
    "taskDetailId": "test-task-detail",
    "resultStatus": 1,
    "fieldData": {
      "field1": "value1",
      "field2": "value2",
      ...
      "field20": "value20"
    }
  }'
```

**预期结果**: 成功处理所有字段，响应时间在可接受范围内

## 性能考虑

### 数据库优化
- **索引建议**: 
  - `wmes_analysis_results(task_detail_id, column_code)` - 复合唯一索引优化查询和更新
  - `wmes_analysis_results(task_detail_id)` - 任务详情ID索引
  - `wmes_analysis_results(result_status)` - 状态索引

### 批量操作优化
- **逐字段处理**: 虽然是逐字段处理，但每个字段的操作都是原子的
- **事务批处理**: 所有字段操作在同一个事务中完成，减少事务开销
- **存在性检查**: 预先检查记录存在性，选择最优的操作策略

### 内存使用
- **字段数量限制**: 建议单次操作的字段数量不超过100个
- **错误信息收集**: 失败字段信息使用Map存储，内存占用可控
- **日志记录**: 合理控制日志输出，避免大量字段时的日志膨胀

## 监控指标

### 关键指标
- **操作成功率**: 完全成功的请求占总请求的比例
- **字段处理成功率**: 成功处理的字段占总字段的比例
- **平均处理字段数**: 每次请求处理的平均字段数量
- **响应时间分布**: 按字段数量分组的响应时间统计

### 异常监控
- **任务详情不存在率**: 请求不存在任务详情的比例
- **字段处理失败率**: 个别字段处理失败的比例
- **数据库异常率**: 数据库操作失败的比例
- **事务回滚率**: 事务回滚的频率

## 错误处理

| 状态码 | 错误类型 | 可能原因 | 解决方案 |
|--------|----------|----------|----------|
| 400 | Bad Request | taskDetailId为空 | 检查请求参数 |
| 400 | Bad Request | resultStatus为空 | 检查请求参数 |
| 400 | Bad Request | fieldData为空或格式错误 | 检查字段数据格式 |
| 500 | Internal Server Error | 数据库连接异常 | 检查数据库连接状态 |
| 500 | Internal Server Error | 事务执行失败 | 检查数据库事务配置 |
| 500 | Internal Server Error | 字段处理异常 | 查看具体字段的失败原因 |

## 使用场景

1. **人工修正**: 用户发现AI解析结果有误，手动修正关键字段
2. **补充信息**: 为缺失的字段补充完整信息
3. **批量确认**: 修正后批量确认多个字段的解析结果
4. **数据标准化**: 将解析结果按照标准格式进行规范化
5. **质量提升**: 通过人工干预提高解析结果的准确性

## 日志追踪

接口使用MDC进行请求追踪：
- **traceId**: 格式为 `updateAnalysis_${UUID}` 的唯一追踪ID
- **日志级别**:
  - INFO: 记录请求接收、处理统计、操作完成等关键节点
  - DEBUG: 记录每个字段的具体处理过程
  - WARN: 记录字段处理失败、任务详情不存在等业务警告
  - ERROR: 记录数据库异常、事务失败等系统错误
- **关键日志**: 包含taskDetailId、字段数量、成功/失败统计等信息

## 安全说明

- **参数验证**: 使用@Valid注解进行严格的请求参数验证
- **SQL注入防护**: 使用JPA的@Query注解和参数绑定，避免SQL注入
- **权限控制**: 建议添加用户权限验证，确保用户只能修改授权范围内的数据
- **数据完整性**: 使用事务确保数据的一致性和完整性
- **操作审计**: 详细记录所有修改操作，便于审计追踪
- **敏感数据**: 对于包含敏感信息的字段，注意数据脱敏和访问控制

## 注意事项

1. **数据一致性**: 修改操作会永久改变数据，操作前请仔细确认
2. **并发控制**: 多用户同时修改同一任务详情时，使用数据库行锁避免冲突
3. **字段数量限制**: 建议单次请求的字段数量控制在合理范围内（建议≤50个）
4. **空值处理**: 支持将字段值设置为空字符串，注意业务逻辑对空值的处理
5. **创建新记录**: 为不存在的字段创建新记录时的特殊处理：
   - `task_id`: 自动从 `wmes_tasks_detail` 表查询获得，如果查询失败会记录警告日志
   - `column_name`: 必须由前端传入，用于设置字段的可读名称
   - `base_data_id`: 允许为空，新记录将设置为 NULL
6. **状态统一**: 所有处理的字段都会设置为相同的result_status
7. **事务边界**: 整个操作在一个事务中完成，任何异常都会导致全部回滚
8. **性能影响**: 大量字段的批量操作可能影响数据库性能，建议在业务低峰期执行

## API版本说明

- **当前版本**: v3  
- **兼容性**: 该接口设计考虑了扩展性，未来可能支持更多字段类型和验证规则
- **废弃计划**: 暂无废弃计划，将持续维护和优化

## 相关接口

- **查询接口**: `GET /api/contract/analysis-results/task/{taskId}` - 查看修改前后的结果
- **批量确认接口**: `POST /api/contract/analysis-results/confirm` - 批量确认任务级别的结果
- **历史记录接口**: 未来可能提供字段修改历史查询接口