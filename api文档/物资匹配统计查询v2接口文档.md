# 物资匹配统计查询v2接口文档

## 接口概述

本接口提供基于v1.3.3新状态定义逻辑的物资匹配统计信息查询功能。

## 接口信息

- **接口名称**: 查询物资匹配统计信息v2
- **接口路径**: `GET /materials/partyb/getMaterialMatchingStatsV2`
- **版本**: v1.3.3
- **方法**: GET

## 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| taskId | String | 是 | 任务ID |

### 请求示例

```http
GET /materials/partyb/getMaterialMatchingStatsV2?taskId=task123
```

## 响应数据

### 响应格式

```json
{
    "totalMaterials": 100,
    "exactMatchCount": 60,
    "infoPendingConfirmationCount": 25,
    "materialInfoPendingCount": 15
}
```

### 响应字段说明

| 字段名 | 类型 | 说明 |
|-------|------|------|
| totalMaterials | BigInteger | 总物资数量 |
| exactMatchCount | BigInteger | 精确匹配数量（完全匹配通过，表格价格低于等于数据库价格） |
| infoPendingConfirmationCount | BigInteger | 信息待确认数量（表格价格高于数据库价格，或已确认的相似/历史匹配） |
| materialInfoPendingCount | BigInteger | 物资信息待处理数量（物资未找到、相似匹配未确认） |

## 状态定义说明

### v1.3.3新状态定义

1. **精确匹配 (exactMatchCount)**
   - 条件: 物资已确认或匹配成功，且价格匹配状态为1（价格匹配）
   - 对应前端显示: 绿色
   - 业务含义: 完全匹配通过，价格合理

2. **信息待确认 (infoPendingConfirmationCount)**
   - 条件: 物资已确认或匹配成功，但价格匹配状态不为1（价格不匹配或价格信息不全）
   - 对应前端显示: 黄色
   - 业务含义: 需要人工确认或价格调整

3. **物资信息待处理 (materialInfoPendingCount)**
   - 条件: 物资未确认且匹配类型不是历史匹配或精确匹配
   - 对应前端显示: 红色
   - 业务含义: 需要补充物资信息或确认匹配

## 统计逻辑

### SQL查询逻辑

```sql
SELECT
    COUNT(*) as totalMaterials,
    SUM(CASE WHEN
        ((t.confirm_result = 1 OR t.comparison_result IN (1, 3)) AND
         EXISTS (SELECT 1 FROM wmes_y_materail_matched_result mr
                 WHERE mr.y_materauk_task_data_id = t.id AND mr.price_matched_status = 1))
        THEN 1 ELSE 0 END) as exactMatchCount,
    SUM(CASE WHEN
        ((t.confirm_result = 1 OR t.comparison_result IN (1, 3)) AND
         NOT EXISTS (SELECT 1 FROM wmes_y_materail_matched_result mr
                     WHERE mr.y_materauk_task_data_id = t.id AND mr.price_matched_status = 1))
        THEN 1 ELSE 0 END) as infoPendingConfirmationCount,
    SUM(CASE WHEN
        (t.confirm_result = 0 AND
         (t.comparison_result NOT IN (1, 3) OR t.comparison_result IS NULL))
        THEN 1 ELSE 0 END) as materialInfoPendingCount
FROM wmes_y_materail_task_data t
WHERE t.task_id = :taskId
```

## 与旧版本对比

### 旧版本状态 (已废弃)
- exactMatchCount: 物资确认匹配且价格匹配
- unmatchedPriceCount: 物资确认匹配但价格未匹配
- pendingMatchCount: 待处理匹配

### 新版本优势
1. **更精确的价格判断**: 支持表格价格与数据库价格的比较
2. **更清晰的业务含义**: 状态定义更贴近实际业务场景
3. **更好的用户体验**: 前端可根据状态提供更准确的操作指引

## 错误处理

### 错误响应格式

```json
{
    "code": 500,
    "message": "查询统计信息失败：具体错误信息",
    "data": null
}
```

### 常见错误

| 错误码 | 错误信息 | 解决方案 |
|-------|---------|----------|
| 400 | 任务ID不能为空 | 检查请求参数 |
| 500 | 查询统计信息失败 | 检查任务ID是否存在，联系技术支持 |

## 使用示例

### cURL请求示例

```bash
curl -X GET "http://localhost:1208/materials/partyb/getMaterialMatchingStatsV2?taskId=task123" \
     -H "Content-Type: application/json"
```

### JavaScript请求示例

```javascript
fetch('/materials/partyb/getMaterialMatchingStatsV2?taskId=task123')
  .then(response => response.json())
  .then(data => {
    console.log('统计信息:', data);
    // 处理统计数据
    const total = data.totalMaterials;
    const exact = data.exactMatchCount;
    const pending = data.infoPendingConfirmationCount;
    const unprocessed = data.materialInfoPendingCount;
  })
  .catch(error => {
    console.error('查询失败:', error);
  });
```

## 注意事项

1. **版本迁移**: 建议从旧版本`getMaterialMatchingStats`接口迁移到本接口
2. **数据一致性**: 统计数据与查询接口保持逻辑一致
3. **性能考虑**: 大数据量时查询可能较慢，建议适当增加超时时间
4. **缓存策略**: 可考虑对统计结果进行短时间缓存

## 更新历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.3.3 | 2024-XX-XX | 初始版本，基于新状态定义逻辑 |