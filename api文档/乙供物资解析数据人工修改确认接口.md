# 乙供物资解析数据人工修改确认接口测试文档

## 接口信息
- **接口路径**: `POST /materials/partyb/manual-confirm`
- **接口描述**: 乙供物资解析数据人工修改确认接口
- **请求方式**: POST
- **Content-Type**: application/json

## 请求参数
```json
{
    "id": "记录主键ID（必填）",
    "confirmBaseDataId": "确认的基础数据ID（必填）", 
    "confirmPriceId": "确认的价格数据ID（必填）"
}
```

### 参数说明
- `id`: String类型，wmes_y_materail_task_data表的主键ID
- `confirmBaseDataId`: String类型，最终确认对应的结果数据ID
- `confirmPriceId`: String类型，最终确认对应的价格数据ID（必填）

### 确认类型自动判断逻辑
系统会根据传入的`confirmBaseDataId`与原数据的比较自动判断确认类型：
- `confirmType = 1`：根据默认推荐确认（当传入的confirmBaseDataId与原confirmBaseDataId相同时）
- `confirmType = 2`：从待选列表选择确认（当传入的confirmBaseDataId与原confirmBaseDataId不同，但在wmes_y_materail_matched_result表中存在时）
- `confirmType = 3`：人工选择数据确认（当传入的confirmBaseDataId与原confirmBaseDataId不同，且在wmes_y_materail_matched_result表中不存在时）

## 响应结果
### 成功响应
```json
{
    "code": 200,
    "message": "确认成功",
    "data": {
        "id": "记录ID",
        "confirmBaseDataId": "确认的基础数据ID",
        "confirmPriceId": "确认的价格数据ID",
        "confirmType": 3,
        "confirmResult": 1,
        "comparisonResult": 0
    }
}
```

### 错误响应
```json
{
    "code": 500,
    "message": "错误信息"
}
```

## 测试用例

### 1. 正常确认测试
```bash
curl -X POST http://localhost:1207/materials/partyb/manual-confirm \
  -H "Content-Type: application/json" \
  -d '{
    "id": "test-id-123",
    "confirmBaseDataId": "base-data-456",
    "confirmPriceId": "price-789"
  }'
```

### 2. 已确认记录测试（应返回错误）
```bash
curl -X POST http://localhost:1207/materials/partyb/manual-confirm \
  -H "Content-Type: application/json" \
  -d '{
    "id": "already-confirmed-id",
    "confirmBaseDataId": "base-data-456",
    "confirmPriceId": "price-789"
  }'
```

### 3. 参数验证测试
```bash
# 缺少必填参数
curl -X POST http://localhost:1207/materials/partyb/manual-confirm \
  -H "Content-Type: application/json" \
  -d '{
    "id": "",
    "confirmBaseDataId": "",
    "confirmPriceId": ""
  }'

# 缺少confirmPriceId
curl -X POST http://localhost:1207/materials/partyb/manual-confirm \
  -H "Content-Type: application/json" \
  -d '{
    "id": "test-id-123",
    "confirmBaseDataId": "base-data-456"
  }'
```

## 业务逻辑说明

1. **参数验证**: 检查ID、confirmBaseDataId和confirmPriceId的有效性（全部必填）
2. **记录查询**: 根据ID查询wmes_y_materail_task_data表中的记录
3. **状态检查**: 验证记录的confirmResult字段，如果已确认(值为1)则拒绝修改
4. **确认类型判断**: 根据传入的confirmBaseDataId与原数据的比较以及在匹配结果表中的存在情况自动判断confirmType
5. **数据更新**: 更新confirmBaseDataId、confirmPriceId、confirmType字段，并设置confirmResult为1
6. **事务保证**: 使用@Transactional确保数据一致性

## 注意事项

1. 接口使用MDC进行请求追踪，便于日志调试
2. 已确认的记录(confirmResult=1)不允许再次修改
3. id、confirmBaseDataId、confirmPriceId均为必填参数
4. confirmType由后端根据传入的confirmBaseDataId与原数据的比较自动判断，无需前端传入
5. 操作成功后会返回更新后的完整记录信息
6. 确认类型判断逻辑：
   - 传入的confirmBaseDataId与原confirmBaseDataId相同 → confirmType=1 (默认推荐)
   - 传入的confirmBaseDataId与原confirmBaseDataId不同，但在匹配结果表中存在 → confirmType=2 (待选列表)
   - 传入的confirmBaseDataId与原confirmBaseDataId不同，且在匹配结果表中不存在 → confirmType=3 (人工选择)